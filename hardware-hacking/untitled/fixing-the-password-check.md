# Улучшение проверки пароля

[**Источник**](https://maldroid.github.io/hardware-hacking/)

Самое простое решение - не оптимизировать цикл for, а проверять каждый символ пароля следующим образом:

```
bool checkPass(String buffer) {
  bool result = true;
  for (int i = 0; i < PASSWORD.length(); i++) {
    if (buffer[i] != PASSWORD[i]) {
      result = false;
    }
  }
  return result;
}
```

Здесь нас ожидает небольшая проблема: в зависимости от того, сколько символов пароля неверны, проверка займет больше времени (с учетом необходимости обновления переменной `result`). Таким образом, если у нас есть один правильный символ, а остальные неправильные, проверка пароля будет быстрее, чем если бы все символы были неправильными.

Cможем ли мы измерить эту очень разницу? Попытка повторить процедуру в поисках самой быстрой проверки пароля, дает неубедительные результаты:

```
63370.0 16 
63358.5 229 �
63346.0 47 /
63314.0 17 
63268.5 0
```

P отсутствует в списке и различия между байтовыми значениями невелики. Значит, проблема решена и наша процедура проверки пароля безопасна!

Но не совсем.&#x20;

Логический анализатор Saleae имеет аналоговые каналы, что делает его немного похожим на осциллограф (это упрощение!). Это означает, что некоторые каналы могут быть использованы не только для считывания логического уровня напряжения, но и для измерения фактического значения напряжения. Почему это важно?

Различные инструкции ЦП имеют разное энергопотребление. Интуитивно (опять же, это упрощение) изменение двух битов будет сопровождаться меньшим потреблением энергии, чем изменение одного бита. Точно так же установка логического значения false приведет к изменению потребления энергии, чем не установка (это должно быть довольно очевидно). Так что, может быть, мы можем просто записать потребление энергии и посмотреть, изменится ли оно, когда попробуем `xxxxx` и `pxxxx`? &#x20;

Сначала мы должны убедиться, что измерение мощности является максимально точным. Для этого нам нужно вынуть микросхему ATMega328, расположить ее на макетной плате и измерить ее энергопотребление, а не всей платы. Причина в том, что плата содержит конденсаторы (как показано в начале этого курса), и эти конденсаторы предназначены для стабилизации тока. Это может повлиять на наши показания.&#x20;

Итак, первое, что нужно сделать, это вынуть ЦП, положить его на макетную плату и снова подключить все выводы ЦП к плате. Это позволит нам удобно взаимодействовать с процессором, используя тот же USB-разъем, который мы использовали раньше.

![](https://maldroid.github.io/hardware-hacking/assets/atmega-breadboard.jpg)

На фотографии видно, что я подключил не все контакты обратно к плате. Нам не нужны все контакты - некоторые из них отвечают за цифровые или аналоговые входы от внешних источников, которые мы не используем. Нам нужны:&#x20;

* Сброс (чтобы мы могли использовать кнопку сброса и перезагрузить ЦП)&#x20;
* RX и TX (для связи с ЦП)
* Питание и заземление ( чип должен быть как-то запитан)&#x20;
* Clock (чтобы ЦП знал, когда выполнять инструкции)

… и все. Всего к плате должно быть подключено 7 контактов. Вы можете узнатьо них больше, посмотрев техническое описание [ATMega328p ](https://maldroid.github.io/hardware-hacking/assets/atmega-datasheet.pdf)- взгляните на верхний правый угол страницы 2.&#x20;

Теперь, когда все подключено, мы сталкиваемся с еще одной небольшой проблемой. Логический анализатор, как и осциллограф, может измерять только напряжение, но не ток, в то время как потребление энергии процессором изменит ток, а не напряжение - напряжение останется более менее неизменным.&#x20;

Напряжение похоже на давление в водопроводном кране, а ток - на фактический расход воды из крана. Когда вы моете руки (делайте это чаще!), вы открываете кран, и вода (ток) начинает течь, а давление остается прежним.&#x20;

Итак, нам нужно измерить ток питания, но мы можем измерить только напряжение. Как это? Для этих целей существуют токовые пробники, которые вы можете купить, они используют эффекта Холла для измерения тока. Однако есть и более дешевое решение - использовать резистор.&#x20;

Согласно закону Ома ток - это напряжение, деленое на сопротивление, а напряжение равно току, умноженному на сопротивление.

![](https://render.githubusercontent.com/render/math?math=V%20=%20I%20\*%20R)

Если сопротивление фиксировано (например, резистор с фиксированным значением), то любые изменения тока приведут к изменениям напряжения, умноженным на это сопротивление. Итак, если у нас есть резистор на 1 Ом, каждое изменение тока (в амперах) будет приводить к числовому изменению напряжения (в вольтах).&#x20;

Если у нас есть резистор с более высоким сопротивлением, то каждое небольшое изменение тока приведет к усиленному изменению напряжения. Однако, если сопротивление слишком велико, ЦП не сможет потреблять мощность, необходимую для выполнения операций. ЦП работает при определенном напряжении (в данном случае 5 В), и если изменение тока приводит к изменению напряжения, в какой-то момент напряжения не будет достаточно для этого изменения, и ЦП отключится.&#x20;

####

Похоже, нужно тщательно выбирать резистор. К счастью, ATMega328 - довольно надежный процессор, и мы можем выбрать довольно высокое значение. Фактически мы будем использовать резистор, указанный ниже. Можете ли вы определить значение сопротивления, взглянув на этот резистор? Попробуйте поискать «цветовой код резистора» в Google.

![](https://maldroid.github.io/hardware-hacking/assets/resistor.jpg)

The way to read the resistance value is to look at the colourful bands and compare them with the chart below. Our resistor has 5 bands: yellow, violet, black, gold and red. [Digikey provides a very convenient resistor colour code calculator](https://www.digikey.com/en/resources/conversion-calculators/conversion-calculator-resistor-color-code-5-band) where you can enter the colour values and you will get the resistance value. In our case it’s 47 Ohms.

Чтобы узнать значение сопротивления, посмотрите на цветные полосы и сравните их с таблицей ниже. У нашего резистора 5 полос: желтая, фиолетовая, черная, золотая и красная. Digikey предоставляет очень удобный [калькулятор цветового](https://www.digikey.com/en/resources/conversion-calculators/conversion-calculator-resistor-color-code-5-band), где вы можете ввести значения цвета и получить значение сопротивления. В нашем случае это 47 Ом.

![](https://maldroid.github.io/hardware-hacking/assets/digikey-resistance.png)

Каждое изменение тока будет умножено на 47, что приведет к изменению напряжения. Теперь, когда все готово, остается только подключить наш резистор к проводу заземления ЦП, подключить логический анализатор к RX, TX и резистору (для измерения напряжения) и собрать данные!

![](https://maldroid.github.io/hardware-hacking/assets/power-analysis-circuit.png)
