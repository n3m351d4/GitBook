---
description: 2021 @in51d3
---

# Hardware Hacking: Ломаем железо с помощью UART

> Перевела @ZzzNein \(безграничную благодарность можно выразить [ЗДЕСЬ](https://yasobe.ru/na/na_perevody_i_kontent)\), проверила @N3M351DA. [Оригинальный текст](https://www.blackhillsinfosec.com/how-to-hack-hardware-using-uart/) - Реймонд Фелч‌

## **Предисловие**

Я начал погружаться в мир обратного проектирования аппаратного обеспечения \(реверс-инжиниринга\) не так давно. Несмотря на то, что я добился значительных успехов в поиске распиновки \(маппинге\) JTAG на плате роутера Linksys BEFSR41 \(Samsung S3C4510 CPU\), я столкнулся с несколькими трудностями. У меня появились проблемы с извлечением прошивки с помощью OpenOCD и нескольких различных адаптеров JTAG \(включая использование самодельного Raspberry Pi3 в качестве адаптера JTAG и SWD \(см.: [https://movr0.com/2016/09/02/use-raspberry-pi-23-as-a-jtagswd-adapter](https://movr0.com/2016/09/02/use-raspberry-pi-23-as-a-jtagswd-adapter)\), который отлично работал и даже обошел скоростные ограничения Bus Pirate.

В некоторых случаях мне удавалось выгружать данные из флэш памяти, но данные оказывались поврежденными и плохо распознавались инструментом binwalk. Эта проблема могла быть связана с синхронизацией или отсутствием у устройства состояния ожидания перед считыванием памяти. Выяснилось, что время от времени производители могут принимать меры предосторожности для защиты данных, завязывая Reset на высокие логические уровни схемы либо блокируя пины JTAG с помощью соответствующих предохранителей \(fuses\) после тестирования устройства на стадии производства. Мой список неразгаданных вопросов пополнился в том числе, еще и потому, что я использовал старую плату в сомнительном состоянии.

Освоение и использование **OpenOCD** \(отладчик с открытым исходным кодом\) само по себе было большим делом. Как говорится в Wiki, «OpenOCD – бесплатное программное обеспечение для отладки систем на кристалле, внутрисистемного программирования и тестирования систем ARM и MIPS». Сервер OpenOCD принимает команды через порты TCP/IP и предоставляет интерфейс, позволяющий взаимодействовать с устройствами. Указанный интерфейс может работать через порт telnet 4444 или с использованием GDB \(отладчик GNU\) на порту 3333.

## Выбор нового роутера и подхода

После неудачи, я решил отдохнуть от предыдущего проекта JTAG и попробовать другой, но схожий, подход к получению доступа к прошивке.

**Примечание**: прежде чем взяться за этот проект, я решил, что хочу начать работу с заведомо исправным устройством, поэтому купил новый роутер Linksys E2500 v3.

![](../../.gitbook/assets/image%20%28308%29.png)

Разбирается он довольно просто - открутите три винта снизу и подденьте крышку линейкой.

![](../../.gitbook/assets/image%20%28303%29.png)

![](../../.gitbook/assets/image%20%28298%29.png)

## Поиск контактов для доступа к UART

Как и в случае использования JTAG, я изучил плату на наличие групп контактов, которые могут дать доступ к последовательному интерфейсу \(TX RX GND\). Я сразу же увидел на плате зону с 5 контактами \(обозначенными JD6\), которые могли быть возможной точкой доступа к UART. Чтобы облегчить себе жизнь, я впаял 5-контактный разъем.

![](../../.gitbook/assets/image%20%28316%29.png)

![](../../.gitbook/assets/image%20%28318%29.png)

Еще я нашел на этой плате контакты JTAG \(они были четко промаркированы TDI, TDO, TCK и TMS\). Там же были контакты CPU \(BCN5358 MIPS\) и Broadcom Radio \(BCM43236\), что указывает на то, что для этой платы использовалось несколько отладчиков. К сожалению, контакты были настолько малы, что мне бы не удалось к ним подсоединиться даже при большом желании, что еще сильней оправдало избранный мною подход.

## JTAGulator – наш лучший друг

С помощью мультиметра я быстро нашел контакт GND \(заземление\) DJ6-5 просто проверив проводимость от каждого контакта на плате до круглого металлизированного контакта \(это делается без подачи питания на плату\). Зная, какой контакт отвечает за заземление, я использовал свой любимый инструмент - JTAGulator и подключил оставшиеся 4 контакта к каналам 0 - 3. Я также подключил контакт GND к GND на JTAGulator.

Все подключено и готово к работе. Я подал питание на целевую плату и JTAGulator, затем запустил **PICOCOM** и получил следующую информацию:

![](../../.gitbook/assets/image%20%28302%29.png)

Набрав H, заходим в меню help. С помощью команды UART мы можем начать искать нужные контакты TX и RX.

![](../../.gitbook/assets/image%20%28317%29.png)

Перед тем как продолжить, нужно задать целевое напряжение ввода-вывода \(I/O\). Для этого используем команду V:

![](../../.gitbook/assets/image%20%28309%29.png)

Теперь, чтобы найти контакты TX и RX можно использовать команду U. Для этого нужно указать, сколько контактов требуется проверить:

![](../../.gitbook/assets/image%20%28314%29.png)

После того как мы нажмем пробел для начала процесса, JTAGulator будет перебирать различные скорости передачи данных, чтобы найти подходящую. Оценив результаты, мы можем определить, что обмен данными лучше всего идет на скорости 115200 бод.

![](../../.gitbook/assets/image%20%28304%29.png)

Окончательные результаты: контакт 3 идет к TX \(DJ6 вывод 2\), контакт 2 идет к RX \(DJ6 вывод 3\), а скорость передачи данных составляет 115200. Дальнейшее тестирование можно провести в режиме сквозной передачи, что позволит напрямую подключиться к чипу, для этого установлена команда P:

![](../../.gitbook/assets/image%20%28312%29.png)

Как видно, мне удалось получить список команд доступных для этого устройства. С помощью команды перезагрузки роутера я получаю дополнительную информацию о своем целевом устройстве. Похоже, мне удалось пообщаться с чипом Broadcom Radio \(BCM43236\) через его драйвер wl.

![](../../.gitbook/assets/image%20%28299%29.png)

Немного поигравшись, я опробовал команду wlhist, которая выгружала стек:

![](../../.gitbook/assets/image%20%28313%29.png)

Затем я использовал команду rpcdump. Она дала интересную, хоть и не очень полезную информацию:

![](../../.gitbook/assets/image%20%28301%29.png)

Просматривая блог «Reverse-Engineering Broadcom Wireless Chipsets» сотрудников Quarkslab.com, я заметил, что они выгружают память с помощью крошечного скрипта PySerial, который реализует команду «md» для запроса дампа памяти. Я много раз безуспешно пытался это осуществить. Я выяснил, что могу получить около 2 КБ данных за время, необходимое чипу на распознавание вторжения и перезагрузку, которое прервет выполнение команды и отключит мой скрипт до записи файла bin. Я также обнаружил, что если бы я сократил свой дамп до 1 КБ \(1024\), то я мог бы собирать данные генерируя маленькие файлы bin размером 1 КБ, что само по себе не так полезно.

## Поиск UART 2

Понимая, что для работы у меня слишком мало команд и, сознавая уровень защиты этого чипа, я решил продолжить поиски другого интерфейса последовательного доступа, который мог бы напрямую подключить меня к процессору Broadcom. Однажды во время поисков в Google я наткнулся на сообщение на одном из форумов о загрузке прошивки. В нем говорилось, что роутер E2500 действительно располагает двумя интерфейсами UART, один из которых бесполезен \(радиочип DJ6 43236\) для попыток разблокировки и взлома оборудования. Это послужило толчком для поиска второго UART. Фактически, мои усилия оправдались и я нашел еще один похожий набор из 5 контактов, промаркированных DJ2, что позволило мне припаять 5-контактный разъем.

![](../../.gitbook/assets/image%20%28293%29.png)

Вместо того, чтобы продолжать использовать JTAGulator в качестве UART, я решил использовать бейдж Attify. Для этого есть две причины: JTAGulator \(хотя он не является дорогим устройством\), в 3 или 4 раза дороже бейджа и мне не хотелось рисковать. Кроме того, Attify более ориентирован на последовательную передачу данных и имеет поддержку UART, SPI и I2C \(как, впрочем, и JTAG\). Его настройка элементарна - D0 и D1 - это TX и RX соответственно, а GND - D8.

![](../../.gitbook/assets/image%20%28296%29.png)

Сразу после включения изучаемого устройства и бейджа Attify передо мной предстала оболочка BusyBox с правами пользователя root.

![](../../.gitbook/assets/image%20%28306%29.png)

![](../../.gitbook/assets/image%20%28307%29.png)

Обратившись к команде «help», я получил список из еще нескольких команд, и сразу же ввел «login». Попытки использовать обычные комбинации admin:admin и admin:password ни к чему не привели, и я несколько раз использовал Ctrl-C. Спустя некоторое время терминал наконец вернул мне строку с «\#». С самого начала я ввел неверный пароль множество раз, но доступ к root я все-таки получил.

Начав с обращений &gt; ls -la, я начал перебирать директории \(и подразделы\) в поисках чего-нибудь интересного \(файлы конфигурации, файлы журналов и т.д.\), пробуя различные команды \(ps, netstat и т.д.\).

![](../../.gitbook/assets/image%20%28311%29.png)

![](../../.gitbook/assets/image%20%28300%29.png)

![](../../.gitbook/assets/image%20%28297%29.png)

![](../../.gitbook/assets/image%20%28310%29.png)

![](../../.gitbook/assets/image%20%28294%29.png)

![](../../.gitbook/assets/image%20%28315%29.png)

![](../../.gitbook/assets/image%20%28305%29.png)

Я получил доступ к прошивке и оболочке Linux, что и было моей целью. Далее мне было необходимо скачать прошивку, чтобы в конечном итоге проанализировать код \(реверс-инжиниринг\), изучить среду и понять, что делает код. Я выполнил несколько проверок, чтобы посмотреть, смогу ли я подключиться к маршрутизатору через Telnet и/или через SSH. Обе попытки окончились неудачей, что говорит о достойном уровне безопасности маршрутизатора. Однако, я все равно смог получить доступ от имени пользователя root, не обладая соответствующими полномочиями, что уже является проблемой безопасности для данного устройства.

Подводя итог, отмечу, что мне понравилось это приключение. Данное исследование принесло довольно быстрые результаты. Я узнал, что есть и другие способы получить доступ к оборудованию, помимо JTAG. Поиск двух последовательных портов UART и использование новых устройств \(бейдж Attify, JTAGulator\) для подключения видятся мне довольно продуктивными альтернативными решениями.

`О том, как можно использовать дальше подобный доступ читайте здесь:`

{% embed url="https://notes.n3m3515.space/hardware-hacking-1/articles/importozameshenie" %}



