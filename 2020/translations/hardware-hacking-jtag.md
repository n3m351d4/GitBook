# Hardware Hacking: JTAG – отладка микроконтроллера

_Перевела @ZzzNein \(безграничную благодарность можно выразить здесь - \), проверила @N3M351DA._ [_Оригинальный текст_](https://www.blackhillsinfosec.com/jtag-micro-controller-debugging/) _- Реймонд Фелч, 23 августа 2019 г._

## Введение

Почти всю жизнь проработав инженером-разработчиком прошивок встраиваемых систем, я довольно быстро заинтересовался реверс-инжинирингом с помощью JTAG. Данный текст поможет больше узнать об этом абстрактном и поэтому зачастую игнорируемом векторе атаки.

_Информация из https://ru.wikipedia.org/wiki/JTAG_

**JTAG** \(сокращение от англ. Joint Test Action Group; произносится «джей-тáг»\) — название рабочей группы по разработке стандарта IEEE 1149. Позднее это сокращение стало прочно ассоциироваться с разработанным этой группой специализированным аппаратным интерфейсом на базе стандарта IEEE 1149.1. Официальное название стандарта **Standard Test Access Port and Boundary-Scan Architecture**. Интерфейс предназначен для подключения сложных цифровых микросхем или устройств уровня печатной платы к стандартной аппаратуре тестирования и отладки.

На текущий момент интерфейс стал промышленным стандартом. Практически все сколько-нибудь сложные цифровые микросхемы оснащаются этим интерфейсом для:

·  выходного контроля микросхем при производстве

·  тестирования собранных печатных плат

·  прошивки микросхем с памятью

·  отладочных работ при проектировании аппаратуры и программного обеспечения

Метод тестирования, реализованный в стандарте, получил название Boundary Scan \(граничное сканирование\). Название отражает первоначальную идею процесса: в микросхеме выделяются функциональные блоки, входы которых можно отсоединить от остальной схемы, подать заданные комбинации сигналов и оценить состояние выходов каждого блока. Весь процесс производится специальными командами по интерфейсу JTAG, при этом никакого физического вмешательства не требуется. Разработан стандартный язык управления данным процессом — Boundary Scan Description Language \(BSDL\).

Стандарт предусматривает возможность подключения большого количества устройств \(микросхем\) через один физический порт \(разъем\).

Порт тестирования \(TAP — Test Access Port\) представляет собой четыре или пять выделенных выводов микросхемы: ТСК, TMS, TDI, TDO и \(опционально\) TRST.  
  
__**JTAG** – отладочный интерфейс, который стал промышленным стандартом для отладки и непрерывной диагностики интегральных схем после сборки печатной платы. Первоначально стандарт предлагал производителям упрощенный способ тестирования конструкции печатной платы. Сейчас он стал еще более актуален ввиду снабжения многих устройств технологией шариковых выводов \(BGA\), что затрудняет тестирование ввиду малых размеров. Кроме того, открытый интерфейс дает инженерам инструмент анализа сигналов без прямого взаимодействия с использованием физического подключения к схеме.

После просмотра множества видео о JTAG я обнаружил ряд положительных преимуществ при получении доступа целевому устройству, в особенности – возможность чтения и записи на эти устройства. Возможности казались безграничными. 

Чтобы начать работу, на местной распродаже я нашел маршрутизатор Linksys BEFSR41 версии 2. Именно его мне не хватало, чтобы начать экспериментировать с некоторыми из огромного количества аппаратных и программных инструментов JTAG. Я решил повторить достижения некоторых авторов тех видео, что просмотрел ранее.

Проведя более глубокие исследования, я решил приобрести плату JTAGulator фирмы Parallax и пару популярных плат с последовательным интерфейсом: DangerousPrototypes Bus Pirate, Bus Blaster и Attify Badge.

Сначала я работал с JTAGulator, аппаратным инструментом с открытым исходным кодом, разработанным Джо Грандом. Он может не только обнаруживать, но и идентифицировать контакты JTAG на целевой плате, что, в свою очередь, дает возможность находить интерфейсы отладки на кристалле \(OCD\). В этом инструменте также заложена возможность находить и идентифицировать контакты UART.

**Характеристики**

· 24 канала I/O с защитой на входе

· регулируемое целевое напряжение для преобразования уровня: 1.2В в 3.3В

· поддерживаемые интерфейсы \(начиная с версии прошивки 1.1.1.\): JTAG/IEEE, UART/асинхронный последовательный порт

· USB-интерфейс \(FTDI FT32\) для прямого соединения с хост-машиной \(ПК, Mac или \*nix\)

![JTAGulator ](../../.gitbook/assets/image%20%28210%29.png)

## **Обнаружение и идентификация контактов JTAG на целевой плате**

Перед тем, как начать, я нашел и распечатал техническое описание целевой платы – роутера Linksys BEFSR41 версии 2.

На плате я быстро обнаружил следующие **элементы**:

· ЦПУ: Samsung S3C4510001    ARM7TDI 50Мгц

· Флэш-ПЗУ:  MX 29F040QC-90    5 вольт CMOS \( 512 Кбит x 8 \) 0.5 МБайт

· SDRAM-память:  SI IC41C16256-35K x2 512 Кбайт – 256К x 16 DRAM

· Ethernet-контроллеры: полнодуплексный контроллер RealTek RTL8019AS ISA

· KENDIN KS8995E 5 портов 10/100 коммутатор в интегральном исполнении

На основании информации, полученной при просмотре обучающих видео о плате JTAGulator \(от автора Джо Гранда\), я нашел элемент, который мог оказаться JTAG TAP \(тестовой точкой доступа\) на JP-1.

Видео о JTAGulator от Джо Гранда: [https://www.youtube.com/watch?v=GgMOBhmEJXA](https://www.youtube.com/watch?v=GgMOBhmEJXA)

### **Обнаружение контактов JTAG**

Часто на плате можно найти обозначения TMS, TCK, TDI, TDO и т.д., по которым можно сразу заключить, что вы имеете дело с устройством, поддерживающем JTAG. Трудности начинают возникать, когда контакты не помечены и приходится полагаться на стороннюю документацию. 

Конечно, может повезти, и на самой плате будет обозначение JTAG без указания контактов/пинов. Точки доступа JTAG зачастую специально скрыты разработчиками, и в большинстве случаев не имеют маркировки. Кроме того, можно заглянуть в техническое описание микроконтроллера. Иногда контакты помечаются JTAG-ориентирами, и дорожки на печатной плате приведут вас к точке доступа.

**Пример:**

![](../../.gitbook/assets/image%20%28209%29.png)

На моей целевой плате этот интерфейс представляет собой 2 ряда по 7 отверстий для разъёма JP-1. 

![](../../.gitbook/assets/image%20%28208%29.png)

И наконец, мне нужно было найти землю на целевом устройстве и подключить ее к контакту GND на плате JTAGulator. 

_ПРИМЕЧАНИЕ: Перед тем, как начинать любое тестирование, убедитесь, что JTAGulator и целевое устройство ОБЯЗАТЕЛЬНО обладают общей точкой заземления \(для обеспечения надлежащего опорного напряжения и верных показаний\)._

Кроме того, с помощью приспособления для демонтажа \(пневмоотсоса припоя\), я удалил припой с отверстий для разъема JP-1 и припаял \(2\) 7-контактные штыревые гребенки, чтобы облегчить подключение перемычек для отладки.

![](../../.gitbook/assets/image%20%28211%29.png)

Используя мультиметр, я определил, что все контакты 2, 4, 6, 8, 10, 12 и 14 привязаны к земле. После этого осталось еще 8 \(неопознанных\) контактов, 5 из которых могли оказаться 4 необходимыми \(и 1 опциональным\) контактами JTAG:

· TDI     Test data in – «вход тестовых данных»

· TDO    Test data out – «выход тестовых данных»

· TMS    Test mode select – «выбор режима тестирования»

· TCK     Test clock – «тестовое тактирование»

· TRST    Test reset \(optional\) – «тестовый сброс» \(опциональный\)

Используя каналы с 0 по 7 на плате JTAGulator, я соединил их перемычками с 8 \(неизвестными\) контактами на целевом устройстве \(порядок подключения не имел значения\).

_Примечание: контакт-14 – это зеленая перемычка \(GND\)._

![](../../.gitbook/assets/image%20%28212%29.png)

![](../../.gitbook/assets/image%20%28213%29.png)



