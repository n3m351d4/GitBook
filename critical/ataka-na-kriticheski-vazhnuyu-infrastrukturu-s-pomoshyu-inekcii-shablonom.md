---
description: 'Перевод: 5∆17Ø'
cover: >-
  https://images.unsplash.com/photo-1516937941344-00b4e0337589?crop=entropy&cs=srgb&fm=jpg&ixid=MnwxOTcwMjR8MHwxfHNlYXJjaHwxfHxpbmR1c3RyaWFsfGVufDB8fHx8MTYzNjQ3MDY2Nw&ixlib=rb-1.2.1&q=85
coverY: 0
---

# Атака на критически важную инфраструктуру с помощью инъекции шаблоном

## **Краткая сводка**

Злоумышленники постоянно пытаются найти новые пути доставки вредоносного ПО по электронной почте. [Cisco Talos Intelligence Group](http://talosintelligence.com) (далее - Talos) обнаружили фишинговую атаку с помощью вложенного документа, отправленного по электронной почте, нацеленную на энергетический сектор, включающий ядерную энергетику. Как правило, вредоносные документы Word, отправляемые в виде вложений в фишинговые электронные письма содержат скрипт или макрос, который выполняет вредоносный код, а в этом случае во вложении вредоносный код отсутствует. Вложение пытается загрузить шаблон через соединение SMB, чтобы скомпрометировать учетные данные пользователя. Кроме того, этот шаблон может также использоваться для загрузки других вредоносных программ на компьютер жертвы.

## **Предпосылки**

По крайней мере с мая 2017 года Talos фиксировал атаки на критически важные инфраструктуры энергетических компаний по всему миру, в первую очередь в Европе и США. Эти атаки направлены как на поставщиков критически важных инфраструктур, так и на поставщиков критически важных услуг, которые используют эти инфрастуктуры. Такие атаки не являются открытием для исследователей в области безопасности, поскольку злоумышленники постоянно стремятся понять системы безопасности промышленного контроля по неизвестным, но, несомненно, гнусным причинам.

Похоже, что одной из целей этой последней атаки является сбор учетных данных работников критически важных инфраструктур и обрабатывающих отраслей. Используя улучшенную версию старого метода атаки, злоумышленник украл учетные данные у своих жертв, отправив вредоносные текстовые документы по электронной почте. Эти документы при открытии пытаются получить файл шаблона с внешнего SMB-сервера, управляемого злоумышленником.

## **Исследование**

В разгар последних тенденций атак и глобальных кампаний стало легче защититься от простых методов, которые служат атакующим в течение многих лет. **** Как недавно заметил Talos, иногда свежий подход к старым методам может сделать их еще эффективнее.

При исследовании вышеупомянутой атаки и изучения предоставленных данных мы обнаружили несколько интересных образцов DOCX, которые были получены в виде вложений в вредоносные спам-сообщения. Как показано ниже, эти документы часто выглядят как экологические отчеты или резюме:

![](<../.gitbook/assets/image (324).png>)



Применение методов социальной инженерии для создания убедительно выглядящих документов, чтобы побудить жертву открыть их — это метод, часто используемый злоумышленниками. У нас нет никаких доказательств того, что эти документы являются чем-то иным, кроме вредоносов. Кроме того, у нас нет информации, позволяющей предположить, что лица, упомянутые в любом из этих документов, являются жертвами этой атаки.

Наши исследователи предположили, что мы обнаружим некоторые вредоносные VBA макросы или встроенные скрипты в самом файле. Проверка VBA кода не подтвердила этих предположений:

![](https://telegra.ph/file/91d4b19e5c2cd6f462308.png)

Мы убедились в этом, проверив код с помощью аналогичного инструмента:

![](https://telegra.ph/file/adfe98eb112f86df429da.png)

Ни один из обычных признаков встроенного бинарника не был обнаружен нашим анализом. Образец был получен в нашей песочнице путем исследования IP-адреса, связанного с атакой, но сервер больше не принимал запросы во время запуска песочницы. Во время исследования других потенциальных жертв мы создали песочницу с сервером, прослушивающим TCP 80, чтобы зафиксировать любые попытки вредоноса связаться с удаленным сервером.

На экране загрузки Word мы заметили кое-что интересное:

![](https://telegra.ph/file/2369eb9d6288f81207505.png)

Документ пытался получить файл шаблона с определенного IP-адреса, но ни одно соединение через TCP 80 не достигло сервера. Конечно же, наш захват показал неудачное рукопожатие по TCP 445. Пришло время вручную разобрать содержимое документа по рассматриваемому IP-адресу. Вместо кода мы нашли экземпляр внедрения шаблона:

![](https://telegra.ph/file/982c44d2eebd641fe37f9.png)

Изначально мы предполагали, что вредоносный SMB-сервер использовался для сбора учетных данных пользователей. Как показано в примере, очевидно, что внедренный шаблон использовался для соединения с внешним сервером через SMB. Тем не менее, это не объясняет, почему тот же образец пытался установить соединение через TCP 80. После дальнейших исследований мы определили, что песочница имеет установленное предпочтение SMB для этого типа подключения.

Короче говоря, из-за сетевых настроек хоста была предпринята попытка установить соединение WebDAV через сеанс SMB при запросе шаблона. Это было подтверждено другим похожим примером, когда другой внешний сервер все еще слушал TCP 80, но больше не обслуживал шаблон.

![](https://telegra.ph/file/e9055d09e8fd87459a489.png)PCAP песочница

Единственный элемент в коде из шаблона, который можно было исследовать дальше - ID rId1337, который присутствовал в word/\_rels/settings.xml.rels. Исследование этого идентификатора привело нас к странице GitHub фишингового инструмента под названием [Phishery,](https://github.com/ryhanson/phishery) который использовал тот же идентификатор в своем внедрении шаблона:

![](https://telegra.ph/file/0eee5e11f7417f5e91629.png)

Тот же идентификатор находится в нижней части кода вышеупомянутого источника:

![](https://telegra.ph/file/69d93458c62db08043869.png)

Phishery, однако, НЕ использует вредоносный SMB-сервер. Скорее, соединение обрабатывается по HTTPS, а учетные данные пользователя собираются с помощью базовой аутентификации с запросом учетных данных. Такой метод не имеет смысла для образцов, запрашивающих шаблон через SMB. Тот факт, что и этот инструмент, и заявленная атака основаны на внедрении шаблона с одинаковым идентификатором, предполагают одно из следующего:

1\. Простое совпадение (всегда возможно);

2\. Злоумышленники обратили внимание на этот инструмент и либо модифицировали его, либо разработали свою атаку с нуля, придерживаясь той же концепции, что и инструмент;

3\. Злоумышленники использовали один и тот же идентификатор, чтобы помешать анализу самой атаки;

В настоящее время нет никаких доказательств, подтверждающих хоть один из трех вариантов. Однако уверенность злоумышленников в успешном сеансе SMB, связанном с исходящим трафиком по TCP 445, еще раз подтверждает, что организациям все еще не удается должным образом заблокировать такой выходной трафик для общедоступных хостов. Без запроса учетных данных, необходимых для изменения SMB, мы можем понять простоту и эффективность такого метода. Если злоумышленник может скомпрометировать хост и запустить такой сервер изнутри, ситуация становится значительно более серьезной.

Кроме того, поскольку контролируемый злоумышленником сервер SMB не работал, когда мы анализировали эти образцы, невозможно определить предельные полезные нагрузки (если таковые имеются), которые могли быть обработаны сервером. Как мы смогли убедиться на примере недавних инцидентов, цель атаки не всегда очевидна. Направление запросов SMB на внешний сервер было известной уязвимостью в течение многих лет. Без дополнительной информации невозможно сделать вывод о том, какова была истинная цель этой атаки или какие вредоносные данные могли быть задействованы.

\


**Вывод**

Talos отреагировал на эти атаки, обратившись к известным пострадавшим клиентам и убедившись в том, что они осведомлены и способны ответить на угрозу. Это также иллюстрирует важность контроля сетевого трафика и запрета на использование исходящих протоколов, таких как SMB, за исключением случаев, когда это действительно требуется. Кроме того, было написано несколько сигнатур ClamAV и правил электронной почты, чтобы гарантировать, что угрозы, использующие этот метод внедрения шаблонов Office, будут заблокированы в будущем.

\


**Дополнительно**

Подписи ClamAV, созданные для идентификации этой атаки:

Doc.Tool.Phishery-6331699-0

Doc.Downloader.TemplateInjection-6332119-0

Doc.Downloader.TemplateInjection-6332123-0

Дополнительные способы, которыми наши клиенты могут обнаружить и заблокировать эту угрозу, перечислены ниже:

![](https://telegra.ph/file/3c29bbd7be928f4e4c6fa.png)

Advanced Malware Protection ([AMP](https://www.cisco.com/c/en/us/support/security/amp-firepower-software-license/tsd-products-support-series-home.html)) блокирует вредоносные текстовые документы.

[CWS](https://www.cisco.com/c/en/us/products/security/cloud-web-security/index.html) , [WSA](https://www.cisco.com/c/en/us/products/security/web-security-appliance/index.html) и [Umbrella](https://umbrella.cisco.com) могут помочь идентифицировать исходящие соединения, используемые такими вредоносами. [Email Security](https://www.cisco.com/c/en/us/products/security/email-security-appliance/index.html) может блокировать вредоносные электронные письма. [AMP Threat Grid](https://www.cisco.com/c/en/us/solutions/enterprise-networks/amp-threat-grid/index.html) помогает идентифицировать вредоносные двоичные файлы и обеспечивает защиту всех продуктов Cisco Security.

\


**IOCS(Indicator of compromise) - индикаторы компрометации**

Мы не можем поделиться всеми индикаторами, тем не менее, хотелось бы поделиться как можно большим, чтобы поддержать дух прозрачности и сотрудничества.

**Вредоносные документы:**

**1)** Filename: Report03-23-2017.docx

SHA256: 93cd6696e150caf6106e6066b58107372dcf43377bf4420c848007c10ff80bc9

**2)** Filename: Controls Engineer.docx

SHA256: (1) b02508baf8567e62f3c0fd14833c82fb24e8ba4f0dc84aeb7690d9ea83385baa

&#x20;       (2) 3d6eadf0f0b3fb7f996e6eb3d540945c2d736822df1a37dcd0e25371fa2d75a0

&#x20;       (3) ac6c1df3895af63b864bb33bf30cb31059e247443ddb8f23517849362ec94f08

**Связанные IP-адреса:**

184\[.]154\[.]150\[.]66

5\[.]153\[.]58\[.]45

62\[.]8\[.]193\[.]206

\


\


_Авторы:_ [_Sean Baird_](https://www.linkedin.com/in/seanrichardbaird/)_,_ [_Earl Carter_](https://www.blogger.com/profile/07833323932899203321)_,_ [_Erick Galinkin_](https://twitter.com/krabsonsecurity)_,_ [_Christopher Marczewski_ ](https://www.linkedin.com/in/christophermarczewski/)_&_ [_Joe Marshall_ ](https://twitter.com/ImmortanJo3)

[_Источник_](https://blog.talosintelligence.com/2017/07/template-injection.html)

_Перевод:_ [_5∆17Ø_](https://t.me/beh1ndy0urback)
